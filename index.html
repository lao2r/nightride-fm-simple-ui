<html>

<head>
    <base href="https://nightride.fm/">
    <title>Synthwave Radio - NightRide.fm</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Orbitron', sans-serif;
            background-color: #171615;
            color: #beb6a9;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .container {
            CONTAIN-INTRINSIC-BLOCK-SIZE: AUTO 100PX;
            position: relative;
            width: 100%;
            max-width: 800px;
            max-height: 600px;
            height: 99.5%;
            border-radius: 10px;
            box-shadow: 0 0 10px;
            overflow: hidden;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .overlay.noise {
            z-index: 800;
            animation: grain 8s steps(10) infinite;
            background-image: url(https://nightride.fm/static/img/noise.png);
            height: 400%;
            left: -50%;
            top: -150%;
            width: 300%;
            background-size: auto;
            opacity: .2;
        }

        .overlay.scanline {
            z-index: 1010;
            animation: scanline 7.77s linear infinite;
            background: linear-gradient(to bottom,
                    transparent 80%,
                    rgba(0, 0, 0, 0.3) 90%);
            background-size: 100% 4px;
            background-repeat: repeat-x;
        }

        @keyframes grain {

            0%,
            100% {
                transform: translate(0, 0);
            }

            10% {
                transform: translate(-5%, -10%);
            }

            20% {
                transform: translate(-15%, 5%);
            }

            30% {
                transform: translate(7%, -25%);
            }

            40% {
                transform: translate(-5%, 25%);
            }

            50% {
                transform: translate(-15%, 10%);
            }

            60% {
                transform: translate(15%, 0%);
            }

            70% {
                transform: translate(0%, 15%);
            }

            80% {
                transform: translate(3%, 35%);
            }

            90% {
                transform: translate(-10%, 10%);
            }
        }

        @keyframes scanline {
            100% {
                transform: translateY(0);
            }

            0% {
                transform: translateY(100%);
            }
        }

        .logo {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 24px;
            text-shadow: 0 0 10px;
            user-select: none;
        }

        .controls {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            height: 220px;
            user-select: none;
            outline: none;
        }

        .btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            margin: 0 10px;
            transition: all 0.3s ease;
            width: 30px;
            user-select: none;
            outline: none;
        }

        .btn:hover svg {
            filter: drop-shadow(2px 2px 5px rgba(0, 0, 0, 0.3));
        }

        .btn svg {
            transition: filter 0.3s ease;
            filter: drop-shadow(0px 0px 2px rgb(255, 255, 255));
        }

        .volume-bar {
            width: 100px;
            left: 10;
            height: 5px;
            position: relative;
            border-radius: 5px;
            overflow: hidden;
            transition: box-shadow 0.3s ease;
            user-select: none;
        }

        .volume-bar:hover {
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }

        .volume-level {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 50%;
            box-shadow: 0 0 10px;
            user-select: none;
        }

        #status {
            position: absolute;
            top: 60px;
            left: 20px;
            text-shadow: 0 0 black;
            font-size: 14px;
            user-select: none;
        }

        #currentInfo {
            position: absolute;
            top: 80px;
            left: 20px;
            text-shadow: 0 0 black;
            font-size: 14px;
            user-select: none;
        }

        canvas {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
        }

        #frequencyCanvas {
            top: 50%;
            transform: translateY(-50%);
            user-select: none;
        }

        .style-buttons {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            width: 90%;
            user-select: none;
            outline: none;
        }

        .style-btn {
            background: #00000075;
            border: 1px solid;
            font-size: 12px;
            cursor: pointer;
            margin: 5px;
            padding: 5px 10px;
            border-radius: 15px;
            transition: all 0.3s ease;
            user-select: none;
            outline: none;
        }

        .style-btn:hover,
        .style-btn.active {
            color: #171615;
        }

        /* Chillsynth - unchanged */
        body.chillsynth {
            /* background-color: #d39b6ef0; */
            color: #beb6a9;
        }

        .chillsynth .container {
            background: linear-gradient(45deg, #3a1c3d, #251320);
            border: 2px solid #a923c2;
            box-shadow: 0 0 10px #e02cd2;
        }

        .chillsynth .logo {
            color: #d8faf2;
            text-shadow: 0 0 10px #84e7ff;
        }

        .chillsynth .btn {
            color: #d8faf2;
        }

        .chillsynth .btn:hover {
            text-shadow: 0 0 10px #e02cd2;
        }

        .chillsynth .volume-bar {
            background: #435155;
        }

        .chillsynth .volume-level {
            background: linear-gradient(90deg, #a923c2, #e02cd2);
            box-shadow: 0 0 10px #e02cd2;
        }

        .chillsynth #currentInfo {
            color: #e02cd2;
        }

        .chillsynth .style-btn {
            border-color: #a923c2;
            color: #d8faf2;
        }

        .chillsynth .style-btn:hover,
        .chillsynth .style-btn.active {
            background-color: #a923c2;
        }
        
        .chillsynth .btn svg {
            transition: filter 0.3s ease;
            filter: drop-shadow(0px 0px 3px #a923c2);
        }

        .chillsynth .btn:hover svg {
            filter: drop-shadow(2px 2px 5px rgba(0, 0, 0, 0.3));
        }

        /* Nightride - Blade Runner inspired */
        body.nightride {
            background-color: #171615;
            color: #66fcf1;
        }

        .nightride .container {
            background: linear-gradient(45deg, #1f2833, #0b0c10);
            border: 2px solid #45a29e;
            box-shadow: 0 0 10px #66fcf1;
        }

        .nightride .logo {
            color: #66fcf1;
            text-shadow: 0 0 10px #45a29e;
        }

        .nightride .btn {
            color: #66fcf1;
        }

        .nightride .btn:hover {
            text-shadow: 0 0 10px #45a29e;
        }

        .nightride .volume-bar {
            background: #1f2833;
        }

        .nightride .volume-level {
            background: linear-gradient(90deg, #45a29e, #66fcf1);
            box-shadow: 0 0 10px #66fcf1;
        }

        .nightride #currentInfo {
            color: #45a29e;
        }

        .nightride .style-btn {
            border-color: #45a29e;
            color: #66fcf1;
        }

        .nightride .style-btn:hover,
        .nightride .style-btn.active {
            background-color: #45a29e;
        }

        .nightride .btn svg {
            transition: filter 0.3s ease;
            filter: drop-shadow(0px 0px 3px #45a29e);
        }

        .nightride .btn:hover svg {
            filter: drop-shadow(2px 2px 5px rgba(0, 0, 0, 0.3));
        }

        /* Datawave - 80s Computer Terminal */
        body.datawave {
            background-color: #171615;
            color: #00ff00;
        }

        .datawave .container {
            background: linear-gradient(45deg, #001100, #002200);
            border: 2px solid #00ff00;
            box-shadow: 0 0 10px #00ff00;
        }

        .datawave .logo {
            color: #00ff00;
            text-shadow: 0 0 10px #00aa00;
        }

        .datawave .btn {
            color: #00ff00;
        }

        .datawave .btn:hover {
            text-shadow: 0 0 10px #00aa00;
        }

        .datawave .volume-bar {
            background: #001100;
        }

        .datawave .volume-level {
            background: linear-gradient(90deg, #00aa00, #00ff00);
            box-shadow: 0 0 10px #00ff00;
        }

        .datawave #currentInfo {
            color: #00aa00;
        }

        .datawave .style-btn {
            border-color: #00aa00;
            color: #00ff00;
        }

        .datawave .style-btn:hover,
        .datawave .style-btn.active {
            background-color: #00aa00;
        }

        .datawave .btn svg {
            transition: filter 0.3s ease;
            filter: drop-shadow(0px 0px 3px #00aa00);
        }

        .datawave .btn:hover svg {
            filter: drop-shadow(2px 2px 5px rgba(0, 0, 0, 0.3));
        }

        /* Spacesynth - 80s Sci-Fi */
        body.spacesynth {
            background-color: #171615;
            color: #e762d7;
        }

        .spacesynth .container {
            background: linear-gradient(45deg, #1e1637, #0c0b13);
            border: 2px solid #e762d7;
            box-shadow: 0 0 10px #b52cc7;
        }

        .spacesynth .logo {
            color: #e762d7;
            text-shadow: 0 0 10px #b52cc7;
        }

        .spacesynth .btn {
            color: #e762d7;
        }

        .spacesynth .btn:hover {
            text-shadow: 0 0 10px #b52cc7;
        }

        .spacesynth .volume-bar {
            background: #1e1637;
        }

        .spacesynth .volume-level {
            background: linear-gradient(90deg, #b52cc7, #e762d7);
            box-shadow: 0 0 10px #e762d7;
        }

        .spacesynth #currentInfo {
            color: #b52cc7;
        }

        .spacesynth .style-btn {
            border-color: #b52cc7;
            color: #e762d7;
        }

        .spacesynth .style-btn:hover,
        .spacesynth .style-btn.active {
            background-color: #b52cc7;
        }

        .spacesynth .btn svg {
            transition: filter 0.3s ease;
            filter: drop-shadow(0px 0px 3px #b52cc7);
        }

        .spacesynth .btn:hover svg {
            filter: drop-shadow(2px 2px 5px rgba(0, 0, 0, 0.3));
        }

        /* Darksynth - Terminator inspired */
        body.darksynth {
            background-color: #171615;
            color: #ff3c00;
        }

        .darksynth .container {
            background: linear-gradient(45deg, #2b2b2b, #1a1a1a);
            border: 2px solid #ff3c00;
            box-shadow: 0 0 10px #ff3c00;
        }

        .darksynth .logo {
            color: #ff3c00;
            text-shadow: 0 0 10px #b32900;
        }

        .darksynth .btn {
            color: #ff3c00;
        }

        .darksynth .btn:hover {
            text-shadow: 0 0 10px #b32900;
        }

        .darksynth .volume-bar {
            background: #2b2b2b;
        }

        .darksynth .volume-level {
            background: linear-gradient(90deg, #b32900, #ff3c00);
            box-shadow: 0 0 10px #ff3c00;
        }

        .darksynth #currentInfo {
            color: #b32900;
        }

        .darksynth .style-btn {
            border-color: #b32900;
            color: #ff3c00;
        }

        .darksynth .style-btn:hover,
        .darksynth .style-btn.active {
            background-color: #b32900;
        }

        .darksynth .btn svg {
            transition: filter 0.3s ease;
            filter: drop-shadow(0px 0px 3px #b32900);
        }

        .darksynth .btn:hover svg {
            filter: drop-shadow(2px 2px 5px rgba(0, 0, 0, 0.3));
        }

        /* Horrorsynth - 80s Horror */
        body.horrorsynth {
            background-color: #171615;
            color: #ff0000;
        }

        .horrorsynth .container {
            background: linear-gradient(45deg, #1a0000, #000000);
            border: 2px solid #ff0000;
            box-shadow: 0 0 10px #800000;
        }

        .horrorsynth .logo {
            color: #ff0000;
            text-shadow: 0 0 10px #800000;
        }

        .horrorsynth .btn {
            color: #ff0000;
        }

        .horrorsynth .btn:hover {
            text-shadow: 0 0 10px #800000;
        }

        .horrorsynth .volume-bar {
            background: #1a0000;
        }

        .horrorsynth .volume-level {
            background: linear-gradient(90deg, #800000, #ff0000);
            box-shadow: 0 0 10px #ff0000;
        }

        .horrorsynth #currentInfo {
            color: #800000;
        }

        .horrorsynth .style-btn {
            border-color: #800000;
            color: #ff0000;
        }

        .horrorsynth .style-btn:hover,
        .horrorsynth .style-btn.active {
            background-color: #800000;
        }

        .horrorsynth .btn svg {
            transition: filter 0.3s ease;
            filter: drop-shadow(0px 0px 3px #800000);
        }

        .horrorsynth .btn:hover svg {
            filter: drop-shadow(2px 2px 5px rgba(0, 0, 0, 0.3));
        }

        /* EBSM - 90s Electronica */
        body.ebsm {
            background-color: #171615;
            color: #00ffff;
        }

        .ebsm .container {
            background: linear-gradient(45deg, #000066, #000033);
            border: 2px solid #00ffff;
            box-shadow: 0 0 10px #0080ff;
        }

        .ebsm .logo {
            color: #00ffff;
            text-shadow: 0 0 10px #0080ff;
        }

        .ebsm .btn {
            color: #00ffff;
        }

        .ebsm .btn:hover {
            text-shadow: 0 0 10px #0080ff;
        }

        .ebsm .volume-bar {
            background: #000066;
        }

        .ebsm .volume-level {
            background: linear-gradient(90deg, #0080ff, #00ffff);
            box-shadow: 0 0 10px #00ffff;
        }

        .ebsm #currentInfo {
            color: #0080ff;
        }

        .ebsm .style-btn {
            border-color: #0080ff;
            color: #00ffff;
        }

        .ebsm .style-btn:hover,
        .ebsm .style-btn.active {
            background-color: #0080ff;
        }

        .ebsm .btn svg {
            transition: filter 0.3s ease;
            filter: drop-shadow(0px 0px 3px #0080ff);
        }

        .ebsm .btn svg {
            transition: filter 0.3s ease;
            filter: drop-shadow(0px 0px 3px #0080ff);
        }

        .ebsm .btn:hover svg {
            filter: drop-shadow(2px 2px 5px rgba(0, 0, 0, 0.3));
        }

    </style>
</head>

<body class="chillsynth">
    <div class="container">
        <div class="overlay noise"></div>
        <div class="overlay scanlines __web-inspector-hide-shortcut__"></div>
        <div class="overlay scanline"></div>
        <div class="logo"><a style="color: inherit; text-decoration: none;">NIGHTRIDE.FM</a></div>
        <div id="status">Ready to play</div>
        <div id="currentInfo"></div>
        <canvas id="frequencyCanvas"></canvas>
        <canvas id="barsCanvas"></canvas>
        <div class="controls" style="top: 40px;">
            <button id="playBtn" class="btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white">
                <path d="M8 5v14l11-7z"/></svg></button>
            <button id="muteBtn" class="btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white">
                <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg></button>
            <div class="volume-bar" style="cursor: pointer;">
                <div class="volume-level"></div>
            </div>
        </div>
        <div class="style-buttons">
            <button class="style-btn" data-style="nightride">NIGHTRIDE</button>
            <button class="style-btn active" data-style="chillsynth">CHILLSYNTH</button>
            <button class="style-btn" data-style="datawave">DATAWAVE</button>
            <button class="style-btn" data-style="spacesynth">SPACESYNTH</button>
            <button class="style-btn" data-style="darksynth">DARKSYNTH</button>
            <button class="style-btn" data-style="horrorsynth">HORRORSYNTH</button>
            <button class="style-btn" data-style="ebsm">EBSM</button>
        </div>
    </div>

    <script>
        // Polyfill for requestAnimationFrame with debug logs
        (function() {
            console.log("Initializing polyfill for requestAnimationFrame...");

            var lastTime = 0;
            var vendors = ['ms', 'moz', 'webkit', 'o'];
            for (var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
                window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];
                window.cancelAnimationFrame = window[vendors[x] + 'CancelAnimationFrame'] 
                                           || window[vendors[x] + 'CancelRequestAnimationFrame'];
            }

            if (!window.requestAnimationFrame) {
                console.log("requestAnimationFrame not supported, using setTimeout as fallback.");
                window.requestAnimationFrame = function(callback) {
                    var currTime = new Date().getTime();
                    var timeToCall = Math.max(0, 16 - (currTime - lastTime));
                    var id = window.setTimeout(function() { callback(currTime + timeToCall); }, 
                      timeToCall);
                    lastTime = currTime + timeToCall;
                    return id;
                };
            }

            if (!window.cancelAnimationFrame) {
                window.cancelAnimationFrame = function(id) {
                    clearTimeout(id);
                };
            }

            console.log("requestAnimationFrame initialized.");
        }());

        let audioElement;
        let playing = false;
        let audioContext;
        let analyser;
        let isMuted = false;
        let animationId;
        let currentStyle = 'chillsynth';
        let metaInfo = {};
        let userInteracted = false;

        const playBtn = document.getElementById('playBtn');
        const muteBtn = document.getElementById('muteBtn');
        const status = document.getElementById('status');
        const currentInfo = document.getElementById('currentInfo');
        const volumeControl = document.querySelector('.volume-level');
        const volumeBar = document.querySelector('.volume-bar');
        const frequencyCanvas = document.getElementById('frequencyCanvas');
        const barsCanvas = document.getElementById('barsCanvas');
        const styleButtons = document.querySelectorAll('.style-btn');
        const userInteractionDiv = document.getElementById('user-interaction');

        document.addEventListener('keydown', (event) => {
            // Предотвращаем действие для Tab и Ctrl + Shift + I
            if (event.key === 'Tab' || (event.ctrlKey && event.shiftKey && event.key === 'I') || event.key === ' ' || (event.ctrlKey && event.key === 'R') || (event.ctrlKey && event.shiftKey && event.key === 'R')) {
                event.preventDefault();
            }
        });

        document.addEventListener('contextmenu', event => event.preventDefault());

        // Default volume to 50%
        let defaultVolume = 0.5;

        playBtn.addEventListener('click', togglePlay);
        muteBtn.addEventListener('click', toggleMute);

        volumeBar.addEventListener('mousedown', startVolumeChange);
        document.addEventListener('mousemove', changeVolume);
        document.addEventListener('mouseup', stopVolumeChange);

        let isChangingVolume = false;

        function startVolumeChange(e) {
            isChangingVolume = true;
            changeVolume(e);
        }

        function changeVolume(e) {
            if (!isChangingVolume) return;

            const rect = volumeBar.getBoundingClientRect();
            let x = e.clientX - rect.left;
            x = Math.max(0, Math.min(x, rect.width));
            const volume = x / rect.width;

            setVolume(volume);
        }

        function stopVolumeChange() {
            isChangingVolume = false;
        }

        function setVolume(volume) {
            if (audioElement) {
                audioElement.volume = volume;
            }
            defaultVolume = volume;
            volumeControl.style.width = `${volume * 100}%`;
        }

        styleButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const newStyle = e.target.dataset.style;
                if (newStyle !== currentStyle) {
                    document.body.className = newStyle;
                    currentStyle = newStyle;
                    styleButtons.forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    updateVisualColors();
                    if (playing) {
                        stopAudio();
                        playAudio();
                    }
                    updateCurrentInfo();
                    updateButtonStyles();
                }
            });
        });

        const sseUrl = 'https://nightride.fm/meta';
        const eventSource = new EventSource(sseUrl);

        eventSource.onmessage = (event) => {
            if (event.data !== "keepalive") {
                const data = JSON.parse(event.data);
                data.forEach(item => {
                    metaInfo[item.station] = item;
                });
                updateCurrentInfo();
            }
        };

        function updateCurrentInfo() {
            const currentMeta = metaInfo[currentStyle];
            if (currentMeta) {
                const { artist, title, album } = currentMeta;
                currentInfo.textContent = `${artist} - ${title} (${album})`;
            } else {
                currentInfo.textContent = 'Loading track information...';
            }
        }

        function togglePlay() {
            if (playing) {
                pauseAudio();
            } else {
                playAudio();
            }
        }

        function setPlayIcon() {
            playBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white">
                    <path d="M8 5v14l11-7z"/>
                </svg>
            `;
        }

        function setPauseIcon() {
            playBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white">
                    <path d="M14 19h4V5h-4v14zm-10 0h4V5H4v14z"/>
                </svg>
            `;
        }

        function setMuteIcon() {
            muteBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white">
                    <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
            `;
        }

        function setUnmuteIcon() {
            muteBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white">
                    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
            `;
        }

        function playAudio() {
            stopAudio();

            audioElement = new Audio(`https://stream.nightride.fm/${currentStyle}.mp3`);
            audioElement.crossOrigin = "anonymous";
            audioElement.volume = defaultVolume;

            status.textContent = 'Connecting...';
            audioElement.addEventListener('canplay', () => {
                status.textContent = 'Now playing';
                playing = true;
                setPauseIcon();
                setupAudioContext();
            });
            
            audioElement.addEventListener('error', (e) => {
                status.textContent = 'Connecting...';
                playing = false;
                setPlayIcon();
            });
            
            audioElement.play().catch(error => {
                status.textContent = 'Connecting...';
                playing = false;
                setPlayIcon();
            });
        }

        function pauseAudio() {
            if (audioElement) {
                audioElement.pause();
                status.textContent = 'Paused';
                playing = false;
                setPlayIcon();
            }
        }

        function stopAudio() {
            if (audioElement) {
                audioElement.pause();
                audioElement.src = '';
                audioElement.load();
                audioElement = null;
            }
            if (audioContext && audioContext.state !== 'closed') {
                audioContext.close().catch(error => {
                    console.warn('Error closing AudioContext:', error);
                }).finally(() => {
                    audioContext = null;
                    analyser = null;
                });
            } else {
                audioContext = null;
                analyser = null;
            }
            if (animationId) {
                window.cancelAnimationFrame(animationId);
                animationId = null;
            }
            playing = false;
            setPlayIcon();
        }

        function toggleMute() {
            if (audioElement) {
                audioElement.muted = !audioElement.muted;
                isMuted = audioElement.muted;
                if (isMuted) {
                    setMuteIcon();
                } else {
                    setUnmuteIcon();
                }
            }
        }

        function setupAudioContext() {
            if (audioContext && audioContext.state !== 'closed') {
                audioContext.close().catch(error => {
                    console.warn('Error closing existing AudioContext:', error);
                });
            }

            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();

            const source = audioContext.createMediaElementSource(audioElement);
            source.connect(analyser);
            analyser.connect(audioContext.destination);

            resizeCanvas();
            updateVisualizers();
        }

        function updateVisualizers() {
            drawFrequency();
            drawBars();
            animationId = window.requestAnimationFrame(updateVisualizers);
        }

        function drawFrequency() {
            const WIDTH = frequencyCanvas.width;
            const HEIGHT = frequencyCanvas.height;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            analyser.getByteFrequencyData(dataArray);
            const ctx = frequencyCanvas.getContext('2d');
            ctx.clearRect(0, 0, WIDTH, HEIGHT);

            ctx.lineWidth = 1;
            ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('color');
            ctx.beginPath();

            const sliceWidth = WIDTH * 1.0 / (bufferLength / 4);
            let x = 0;

            for (let i = 0; i < bufferLength; i++) {
                const v = dataArray[i] / 128.0;
                const y = v * HEIGHT / 2;

                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }

                x += sliceWidth;
            }

            ctx.lineTo(WIDTH, HEIGHT / 2);
            ctx.stroke();
        }

        function drawBars() {
            const WIDTH = barsCanvas.width;
            const HEIGHT = barsCanvas.height;
            const bufferLength = analyser.frequencyBinCount / 8;
            const dataArray = new Uint8Array(bufferLength);

            analyser.getByteFrequencyData(dataArray);
            const ctx = barsCanvas.getContext('2d');
            ctx.clearRect(0, 0, WIDTH, HEIGHT);

            const barWidth = (WIDTH / bufferLength) * 2.5;
            let x = 0;

            const gradient = ctx.createLinearGradient(0, HEIGHT, 0, 0);
            gradient.addColorStop(0, getComputedStyle(document.body).getPropertyValue('color'));
            gradient.addColorStop(1, getComputedStyle(document.querySelector('#currentInfo')).getPropertyValue('color'));

            for (let i = 0; i < bufferLength; i++) {
                const barHeight = (dataArray[i] / 255) * HEIGHT;

                ctx.fillStyle = gradient;
                ctx.fillRect(x, HEIGHT - barHeight, barWidth, barHeight);

                x += barWidth + 1;
            }
        }

        function updateVisualColors() {
            drawFrequency();
            drawBars();
        }

        function updateButtonStyles() {
            styleButtons.forEach(button => {
                const style = button.dataset.style;
                if (style === currentStyle) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }

        function resizeCanvas() {
            frequencyCanvas.width = frequencyCanvas.offsetWidth;
            frequencyCanvas.height = frequencyCanvas.offsetHeight;
            barsCanvas.width = barsCanvas.offsetWidth;
            barsCanvas.height = barsCanvas.offsetHeight;
        }

        function handleUserInteraction() {
            if (!userInteracted) {
                userInteracted = true;
                userInteractionDiv.classList.add('hidden');
                playAudio();
            }
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        document.addEventListener('touchstart', handleUserInteraction);
        document.addEventListener('click', handleUserInteraction);

    </script>
</body>
</html>
